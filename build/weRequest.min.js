/*!
 * weRequest 1.1.0
 * https://github.com/IvinWu/weRequest
 */
module.exports=function(e){var o={};function n(t){if(o[t])return o[t].exports;var i=o[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:t})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=0)}([function(e,o,n){"use strict";n.r(o);var t={sessionName:"session",loginTrigger:()=>!1,codeToSession:{},successTrigger:()=>!0,urlPerfix:"",successData:e=>e,doNotCheckSession:!1,errorTitle:"操作失败",errorContent:e=>e,reLoginLimit:3,errorCallback:null,reportCGI:!1,mockJson:!1,globalData:!1,sessionExpireKey:"sessionExpireKey"},i={session:"",sessionExpireTime:null,sessionExpire:1/0,sessionIsFresh:!1,logining:!1,isCheckingSession:!1},s=e=>{if(Object.assign(t,e),e.sessionName)try{i.session=wx.getStorageSync(t.sessionName)||""}catch(e){console.error("wx.getStorageSync:fail, can not get session.")}if(e.sessionExpireKey)try{i.sessionExpire=wx.getStorageSync(t.sessionExpireKey)||1/0}catch(e){console.error("wx.getStorageSync:fail, can not get sessionExpire.")}};var r={show:function(e){wx.showToast({title:"boolean"==typeof e?"加载中":e,icon:"loading",mask:!0,duration:6e4})},hide:function(){wx.hideToast()}},c=(e,o)=>{if("function"==typeof e.fail)e.fail(o);else{let e="";if("function"==typeof t.errorTitle)try{e=t.errorTitle(o.data)}catch(e){}else"string"==typeof errorTitle&&(e=t.errorTitle);let n="";if("function"==typeof t.errorContent)try{n=t.errorContent(o.data)}catch(e){}else"string"==typeof t.errorContent&&(n=t.errorContent);wx.showModal({title:e,content:n||"网络或服务异常，请稍后重试",showCancel:!1})}"function"==typeof t.errorCallback&&t.errorCallback(e,o),console.error(o)};var a={get:function(e){wx.getStorage({key:e.originUrl,success:function(o){"function"==typeof e.cache&&e.cache(o.data)?"function"==typeof e.success&&e.success(o.data,{isCache:!0}):1==e.cache&&"function"==typeof e.success&&e.success(o.data,{isCache:!0}),"function"==typeof e.complete&&e.complete()}})},set:function(e,o){(!0===e.cache||"function"==typeof e.cache&&e.cache(o))&&wx.setStorage({key:e.originUrl,data:o})}};var u={start:function(e,o){switch(o){case"checkSession":e._checkSessionStartTime=(new Date).getTime();break;case"login":e._loginStartTime=(new Date).getTime();break;default:e.report&&(e._reportStartTime=(new Date).getTime())}},end:function(e,o){switch(o){case"checkSession":e._checkSessionEndTime=(new Date).getTime(),"function"==typeof t.reportCGI&&t.reportCGI("wx_checkSession",e._checkSessionStartTime,e._checkSessionEndTime);break;case"login":e._loginEndTime=(new Date).getTime(),"function"==typeof t.reportCGI&&t.reportCGI("wx_login",e._loginStartTime,e._loginEndTime);break;default:e.report&&"function"==typeof t.reportCGI&&(e._reportEndTime=(new Date).getTime(),t.reportCGI(e.report,e._reportStartTime,e._reportEndTime))}}};var l=function(e,o,n){if(200===e.statusCode){if("string"==typeof e.data)try{e.data=JSON.parse(e.data)}catch(n){return c(o,e),!1}if(u.end(o),o.isLogin){let n="";try{n=t.codeToSession.success(e.data)}catch(e){}n?o.success(n):c(o,e)}else if(t.loginTrigger(e.data)&&o.reLoginLimit<t.reLoginLimit)i.session="",i.sessionIsFresh=!0,wx.removeStorage({key:t.sessionName,complete:function(){S[n](o)}});else if(t.successTrigger(e.data)&&"function"==typeof o.success){let n=null;try{n=t.successData(e.data)}catch(e){console.error("Function successData occur error: "+e)}o.noCacheFlash||o.success(n),a.set(o,n)}else c(o,e)}else c(o,e)};var f={get:function(e,o){if(!t.mockJson[e.url]&&!t.mockJson[e.originUrl])return console.error("mock 没有对应接口的数据"),!1;let n=t.mockJson[e.url]||t.mockJson[e.originUrl];n=JSON.parse(JSON.stringify(n)),l({data:n,statusCode:200},e,o)}};let p={};function d(e){return p[e]||(p[e]={waitingList:[]}),p[e]}var g={wait:function(e,o){d(e).waitingList.push(o)},emit:function(e){let o=d(e),n=o.waitingList.length;for(let e=0;e<n;e++){let e=o.waitingList.shift();"function"==typeof e&&e()}}};function m(e,o){o.isLogin?"function"==typeof e&&e():i.session?i.sessionExpireTime&&(new Date).getTime()>i.sessionExpire?(i.session="",m(e,o)):"function"==typeof e&&e():i.logining?g.wait("doLoginFinished",function(){m(e,o)}):(i.logining=!0,o.count++,u.start(o,"login"),console.log("wx.login"),wx.login({complete:function(){o.count--,u.end(o,"login"),"function"==typeof o.complete&&0===o.count&&o.complete()},success:function(n){n.code?function(e,o,n){let s;s="function"==typeof t.codeToSession.data?t.codeToSession.data():t.codeToSession.data||{};s[t.codeToSession.codeName]=o,e.count++,S.request({url:t.codeToSession.url,data:s,method:t.codeToSession.method||"GET",isLogin:!0,report:t.codeToSession.report||t.codeToSession.url,success:function(e){i.session=e,i.sessionIsFresh=!0,i.sessionExpireTime&&(i.sessionExpire=(new Date).getTime()+i.sessionExpireTime,wx.setStorage({key:t.sessionExpireKey,data:i.sessionExpire})),"function"==typeof n&&n(),wx.setStorage({key:t.sessionName,data:i.session})},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete(),i.logining=!1,g.emit("doLoginFinished")},fail:t.codeToSession.fail||null})}(o,n.code,e):(c(o,n),console.error(n),i.logining=!1,g.emit("doLoginFinished"))},fail:function(e){c(o,e),console.error(e),i.logining=!1,g.emit("doLoginFinished")}}))}var h=function e(o,n){i.isCheckingSession?g.wait("checkSessionFinished",()=>{e(o,n)}):!i.sessionIsFresh&&i.session?(i.isCheckingSession=!0,n.count++,u.start(n,"checkSession"),wx.checkSession({success:function(){i.sessionIsFresh=!0},fail:function(){i.session=""},complete:function(){i.isCheckingSession=!1,n.count--,u.end(n,"checkSession"),m(o,n),g.emit("checkSessionFinished")}})):m(o,n)};function y(e){return"function"==typeof e.beforeSend&&e.beforeSend(),void 0===e.reLoginLimit?e.reLoginLimit=0:e.reLoginLimit++,void 0===e.count&&(e.count=0),e.showLoading&&(r.show(e.showLoading),e.complete=(e=>()=>{r.hide(),"function"==typeof e&&e.apply(this,arguments)})(e.complete)),e.originUrl=e.url,e.url=function(e){if(e.startsWith("http"))return e;{let o=t.urlPerfix;return"function"==typeof t.urlPerfix&&(o=t.urlPerfix()),o+e}}(e.url),e}function T(e){(e=function(e,o){e[o]||(e[o]={}),e.originUrl!==t.codeToSession.url&&i.session&&(e[o][t.sessionName]=i.session);let n={};if("function"==typeof t.globalData?n=t.globalData():"object"==typeof t.globalData&&(n=t.globalData),e[o]=Object.assign({},n,e[o]),e.method=e.method||"GET",e.dataType=e.dataType||"json","GET"!==e.method){i.session&&(e.url.indexOf("?")>=0?e.url+="&"+t.sessionName+"="+encodeURIComponent(i.session):e.url+="?"+t.sessionName+"="+encodeURIComponent(i.session));for(let o in n)e.url.indexOf("?")>=0?e.url+="&"+o+"="+n[o]:e.url+="?"+o+"="+n[o]}return u.start(e),e}(e,"data")).count++,wx.request({url:e.url,data:e.data,method:e.method,header:e.header||{},dataType:e.dataType||"json",success:function(o){l(o,e,"request")},fail:function(o){c(e,o),console.error(o)},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete()}})}var S={request:function(e){if(e=y(e),t.mockJson)return f.get(e,"request"),!1;e.cache&&a.get(e),h(()=>{T(e)},e)},uploadFile:function(e){if(e=y(e),t.mockJson)return f.get(e,"uploadFile"),!1;e.cache&&a.get(e),h(()=>{!function(e){e.count++,wx.uploadFile({url:e.url,filePath:e.filePath||"",name:e.name||"",method:"POST",formData:e.formData,success:function(o){l(o,e,"uploadFile")},fail:function(o){c(e,o),console.error(o)},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete()}})}(e)},e)}},x=e=>{S.request(e)},w=e=>{S.uploadFile(e)},k=e=>{i.session=e,i.sessionIsFresh=!0},E=e=>{h(e,{})},C=()=>i.session,L=()=>({urlPerfix:t.urlPerfix,sessionExpireTime:i.sessionExpireTime,sessionExpireKey:t.sessionExpireKey,sessionExpire:i.sessionExpire});n.d(o,"init",function(){return s}),n.d(o,"request",function(){return x}),n.d(o,"uploadFile",function(){return w}),n.d(o,"setSession",function(){return k}),n.d(o,"login",function(){return E}),n.d(o,"getSession",function(){return C}),n.d(o,"getConfig",function(){return L})}]);