/*!
 * weRequest 1.1.0
 * https://github.com/IvinWu/weRequest
 */
module.exports=function(e){var n={};function i(t){if(n[t])return n[t].exports;var o=n[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=n,i.d=function(e,n,t){i.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,n){if(1&n&&(e=i(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(i.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)i.d(t,o,function(n){return e[n]}.bind(null,o));return t},i.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(n,"a",n),n},i.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},i.p="",i(i.s=0)}([function(e,n,i){"use strict";i.r(n);var t={sessionName:"session",loginTrigger:()=>!1,codeToSession:{},successTrigger:()=>!0,urlPerfix:"",successData:e=>e,doNotCheckSession:!1,errorTitle:"操作失败",errorContent:e=>e,reLoginLimit:3,errorCallback:null,reportCGI:!1,mockJson:!1,globalData:!1,sessionExpireKey:"sessionExpireKey"},o={session:"",sessionExpireTime:null,sessionExpire:1/0,sessionIsFresh:!1,logining:!1,isCheckingSession:!1},s=e=>{if(Object.assign(t,e),e.sessionName)try{o.session=wx.getStorageSync(t.sessionName)||""}catch(e){console.error("wx.getStorageSync:fail, can not get session.")}if(e.sessionExpireKey)try{o.sessionExpire=wx.getStorageSync(t.sessionExpireKey)||1/0}catch(e){console.error("wx.getStorageSync:fail, can not get sessionExpire.")}};var c={show:function(e){wx.showToast({title:"boolean"==typeof e?"加载中":e,icon:"loading",mask:!0,duration:6e4})},hide:function(){wx.hideToast()}},u=(e,n)=>{if("function"==typeof e.fail)e.fail(n);else{let e="";if("function"==typeof t.errorTitle)try{e=t.errorTitle(n.data)}catch(e){}else"string"==typeof t.errorTitle&&(e=t.errorTitle);let i="";if("function"==typeof t.errorContent)try{i=t.errorContent(n.data)}catch(e){}else"string"==typeof t.errorContent&&(i=t.errorContent);wx.showModal({title:e,content:i||"网络或服务异常，请稍后重试",showCancel:!1})}"function"==typeof t.errorCallback&&t.errorCallback(e,n),console.error(n)};var r={get:function(e){wx.getStorage({key:e.originUrl,success:function(n){"function"==typeof e.cache&&e.cache(n.data)?"function"==typeof e.success&&e.success(n.data,{isCache:!0}):1==e.cache&&"function"==typeof e.success&&e.success(n.data,{isCache:!0}),"function"==typeof e.complete&&e.complete()}})},set:function(e,n){(!0===e.cache||"function"==typeof e.cache&&e.cache(n))&&wx.setStorage({key:e.originUrl,data:n})}};var f={start:function(e,n){switch(n){case"checkSession":e._checkSessionStartTime=(new Date).getTime();break;case"login":e._loginStartTime=(new Date).getTime();break;default:e.report&&(e._reportStartTime=(new Date).getTime())}},end:function(e,n){switch(n){case"checkSession":e._checkSessionEndTime=(new Date).getTime(),"function"==typeof t.reportCGI&&t.reportCGI("wx_checkSession",e._checkSessionStartTime,e._checkSessionEndTime);break;case"login":e._loginEndTime=(new Date).getTime(),"function"==typeof t.reportCGI&&t.reportCGI("wx_login",e._loginStartTime,e._loginEndTime);break;default:e.report&&"function"==typeof t.reportCGI&&(e._reportEndTime=(new Date).getTime(),t.reportCGI(e.report,e._reportStartTime,e._reportEndTime))}}};var l=function(e,n,i){if(200===e.statusCode){if("string"==typeof e.data)try{e.data=JSON.parse(e.data)}catch(i){return u(n,e),!1}if(f.end(n),n.isLogin){let i="";try{i=t.codeToSession.success(e.data)}catch(e){}i?n.success(i):u(n,e)}else if(t.loginTrigger(e.data)&&n.reLoginLimit<t.reLoginLimit)o.session="",o.sessionIsFresh=!0,wx.removeStorage({key:t.sessionName,complete:function(){x[i](n)}});else if(t.successTrigger(e.data)){let i=null;try{i=t.successData(e.data)}catch(e){console.error("Function successData occur error: "+e)}n.noCacheFlash||"function"==typeof n.success&&n.success(i),r.set(n,i)}else u(n,e)}else u(n,e)};var p={get:function(e,n){if(!t.mockJson[e.url]&&!t.mockJson[e.originUrl])return console.error("mock 没有对应接口的数据"),!1;let i=t.mockJson[e.url]||t.mockJson[e.originUrl];i=JSON.parse(JSON.stringify(i)),l({data:i,statusCode:200},e,n)}};let d={};function m(e){return d[e]||(d[e]={waitingList:[]}),d[e]}var a={wait:function(e,n){m(e).waitingList.push(n)},emit:function(e){let n=m(e),i=n.waitingList.length;for(let e=0;e<i;e++){let e=n.waitingList.shift();"function"==typeof e&&e()}}};function g(e,n){n.isLogin?"function"==typeof e&&e():o.session?o.sessionExpireTime&&(new Date).getTime()>o.sessionExpire?(o.session="",g(e,n)):"function"==typeof e&&e():o.logining?a.wait("doLoginFinished",function(){g(e,n)}):(o.logining=!0,n.count++,f.start(n,"login"),console.log("wx.login"),wx.login({complete:function(){n.count--,f.end(n,"login"),"function"==typeof n.complete&&0===n.count&&n.complete()},success:function(i){i.code?function(e,n,i){let s;s="function"==typeof t.codeToSession.data?t.codeToSession.data():t.codeToSession.data||{};s[t.codeToSession.codeName]=n,e.count++,x.request({url:t.codeToSession.url,data:s,method:t.codeToSession.method||"GET",isLogin:!0,report:t.codeToSession.report||t.codeToSession.url,success:function(e){o.session=e,o.sessionIsFresh=!0,o.sessionExpireTime&&(o.sessionExpire=(new Date).getTime()+o.sessionExpireTime,wx.setStorage({key:t.sessionExpireKey,data:o.sessionExpire})),"function"==typeof i&&i(),wx.setStorage({key:t.sessionName,data:o.session})},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete(),o.logining=!1,a.emit("doLoginFinished")},fail:t.codeToSession.fail||null})}(n,i.code,e):(u(n,i),console.error(i),o.logining=!1,a.emit("doLoginFinished"))},fail:function(e){u(n,e),console.error(e),o.logining=!1,a.emit("doLoginFinished")}}))}var y=function e(n,i){o.isCheckingSession?a.wait("checkSessionFinished",()=>{e(n,i)}):!o.sessionIsFresh&&o.session?(o.isCheckingSession=!0,i.count++,f.start(i,"checkSession"),wx.checkSession({success:function(){o.sessionIsFresh=!0},fail:function(){o.session=""},complete:function(){o.isCheckingSession=!1,i.count--,f.end(i,"checkSession"),g(n,i),a.emit("checkSessionFinished")}})):g(n,i)};var h={setParams:function(e="",n){let i=e.indexOf("?"),t={};if(i>=0){let n=e.substr(i+1).split("&");for(let e=0;e<n.length;e++){let i=n[e].split("=");t[i[0]]=i[1]}}t={...t,...n};let o=Object.keys(t).map(e=>`${e}=${encodeURI(t[e])}`).join("&");return i>=0?e.substring(0,i+1)+o:e+"?"+o}};function S(e){return"function"==typeof e.beforeSend&&e.beforeSend(),void 0===e.reLoginLimit?e.reLoginLimit=0:e.reLoginLimit++,void 0===e.count&&(e.count=0),e.showLoading&&(c.show(e.showLoading),e.complete=(e=>()=>{c.hide(),"function"==typeof e&&e.apply(this,arguments)})(e.complete)),e.originUrl||(e.originUrl=e.url,e.url=function(e){if(e.startsWith("http"))return e;{let n=t.urlPerfix;return"function"==typeof t.urlPerfix&&(n=t.urlPerfix()),n+e}}(e.url)),e}function T(e,n){e[n]||(e[n]={}),e.originUrl!==t.codeToSession.url&&o.session&&(e[n][t.sessionName]=o.session);let i={};if("function"==typeof t.globalData?i=t.globalData():"object"==typeof t.globalData&&(i=t.globalData),e[n]=Object.assign({},i,e[n]),e.method=e.method||"GET",e.dataType=e.dataType||"json","GET"!==e.method){if(o.session){let n={};n[t.sessionName]=o.session,e.url=h.setParams(e.url,n)}e.url=h.setParams(e.url,i)}return f.start(e),e}var x={request:function(e){if(e=S(e),t.mockJson)return p.get(e,"request"),!1;e.cache&&r.get(e),y(()=>{!function(e){(e=T(e,"data")).count++,wx.request({url:e.url,data:e.data,method:e.method,header:e.header||{},dataType:e.dataType||"json",success:function(n){l(n,e,"request")},fail:function(n){u(e,n),console.error(n)},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete()}})}(e)},e)},uploadFile:function(e){if(e=S(e),t.mockJson)return p.get(e,"uploadFile"),!1;e.cache&&r.get(e),y(()=>{!function(e){(e=T(e,"formData")).count++,wx.uploadFile({url:e.url,filePath:e.filePath||"",name:e.name||"",method:"POST",formData:e.formData,success:function(n){l(n,e,"uploadFile")},fail:function(n){u(e,n),console.error(n)},complete:function(){e.count--,"function"==typeof e.complete&&0===e.count&&e.complete()}})}(e)},e)}},w=e=>{x.request(e)},k=e=>{x.uploadFile(e)},E=e=>{o.session=e,o.sessionIsFresh=!0},C=e=>{y(e,{})},L=()=>o.session,v=()=>({urlPerfix:t.urlPerfix,sessionExpireTime:o.sessionExpireTime,sessionExpireKey:t.sessionExpireKey,sessionExpire:o.sessionExpire});i.d(n,"init",function(){return s}),i.d(n,"request",function(){return w}),i.d(n,"uploadFile",function(){return k}),i.d(n,"setSession",function(){return E}),i.d(n,"login",function(){return C}),i.d(n,"getSession",function(){return L}),i.d(n,"getConfig",function(){return v})}]);